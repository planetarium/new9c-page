<!DOCTYPE html>
<html lang="en-us">
    <head>
        <style>
            canvas {
                width: min(calc(100vh * (9/16)), 100vw);
                max-width: 100%;
                max-height: 100%;
                height: auto;
                aspect-ratio: 9/16;
                display: block;
            }
        </style>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Unity Web Player | proto</title>
        <script>
            const host = "https://5hxextbfd7.execute-api.ap-northeast-2.amazonaws.com/proto";
            // const host = "http://localhost:3407";
        </script>

        <script src="https://telegram.org/js/telegram-web-app.js"></script>
        <script>
            let token = "";
        </script>
        <script>
            // Telegram
            console.log("Start telegram");
            // Initialize Telegram Web App
            Telegram.WebApp.ready();

            // Get User Data
            const initData = Telegram.WebApp.initDataUnsafe;
            const userData = initData.user;
            let MyGameInstance;

            // Example of sending user data to your server
            async function sendUserDataToServer() {
                // if (!userData) {
                //     alert("User data not available.");
                //     return;
                // }
                const response = await fetch(`${host}/api/auth/login/telegram`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id: userData.id,
                        username: userData.username ?? userData.first_name,
                        is_bot: userData.is_bot ?? false,
                        is_premium: userData.is_premium ?? false,
                        allows_write_to_pm: userData.allows_write_to_pm,
                        photo_url: userData.photo_url ?? "",
                    }),
                });

                const result = await response.json();
                console.log("=======");
                console.log(result);
                console.log("=======");
                if (response.success) {
                    console.log("Connected successfully!");
                } else {
                    console.log("Connection failed: " + result.message);
                }
                token = result.token;
                MyGameInstance.SendMessage("APIClient", "SetUri", host);
                MyGameInstance.SendMessage("APIClient", "SetToken", "Bearer " + result.token);
            }
        </script>

        <script>
            // Move pages
            const movePage = (pageName) => {
                window.open(`${host}/${pageName}#${token}`);
            };
        </script>
    </head>
    <body style="text-align: center; padding: 0; border: 0; margin: 0;">
        <canvas id="unity-canvas"tabindex="-1"
                style="background: #805C65"></canvas>
        <script src="Build/Build.loader.js"></script>
            <script>
                // Unity Game
                createUnityInstance(document.querySelector("#unity-canvas"), {
                    arguments: [],
                    dataUrl: "Build/public.data",
                    frameworkUrl: "Build/public.framework.js",
                    codeUrl: "Build/public.wasm",
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "pl",
                    productName: "proto",
                    productVersion: "1.0",
                    // matchWebGLToCanvasSize: false, // Uncomment this to separately control WebGL canvas render size and DOM element size.
                    // devicePixelRatio: 1, // Uncomment this to override low DPI rendering on high DPI displays.
                }).then(instance => {
                    MyGameInstance = instance;
                    sendUserDataToServer();
                });
            </script>
    </body>
</html>
